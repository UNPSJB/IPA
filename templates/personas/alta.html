{% extends 'index2.html' %}
{% load static semanticui %}
{% load contextMenu %}

{% block wrapper %}
<div class="ui grid" style="margin-bottom:25px;"> 

<div class="row header-content">
	<div class="five wide column">
		<button class="ui primary basic button" onclick="window.location.href='listado'">
			<i class="angle left icon"></i>
			Volver a la lista de personas
		</button>

	</div>
	<div class="six wide column">
		<h1 class="ui center aligned header blue "> Nueva Persona </h1>
	</div>
	<div class="five wide column">
	</div>
</div>
</div>
	{% if message %}
		<div class="ui error message">
		  <i class="close icon"></i>
		  <div class="header">Hubo errores en la carga de la persona:</div>
		    	<li> {{ message }}</li>
		</div>
	{% endif %}

<form class="ui large form" action="{{ form.url_post }}" method="POST">
    {% csrf_token %}
	{% render_form form %}
	<div class="field">
		<label for="id_empresas">Empresas</label>		
	</div>
	<div class="ui grid">
		<div class="row">
			<div class="fifteen wide column" >
				<select class="ui fluid search dropdown empresasDropdown" multiple="" id="empresasDropdown" name="empresas">
					<option value="">Empresas</option>
					{% for empresa in empresas%}
						<option value="{{empresa.cuit}}">
							{{empresa.razonSocial }} - {{ empresa.cuit }}
						</option>
					{% endfor%}
				</select>
			</div>
			<div class="one wide column">
				<button class="ui primary icon button" id="agregarEmpresa" type="button" data-tooltip="Agrega una nueva empresa">
					<i class="plus icon" ></i>
				</button> 
			</div>
		</div>
		<div class="row">
			<div class="sixteen wide column" >
				<div class="field">
					<label for="id_roles">Roles</label>		
					<select class="ui fluid search dropdown" multiple="" name="roles" id="rolesDropdown">
					</select>
				</div>	
			</div>
		</div>
	</div>
	<div class="field director" style="margin-top:25px;">
		<h2> Información de director: </h2>		
	</div>
	<div class="required field director">
		{{ director_form.legajo.errors }}
		<label for="director_form.legajo.id_for_label">Legajo:</label>
		{{ director_form.legajo }}
	</div>
	<div class="required field director">
		{{ director_form.cargo.errors }}
		<label for="director_form.cargo.id_for_label">Cargo:</label>
		{{ director_form.cargo }}
	</div>
	<div class="required field director">
		{{ director_form.fechaInicio.errors }}
		<label for="director_form.fechaInicio.id_for_label">Fecha de inicio:</label>
		{{ director_form.fechaInicio }}
	</div>
			
	<div class="field chofer">
		<h2> Información de chofer: </h2>		
	</div>
	<div class="required field chofer">
		{{ chofer_form.licencia.errors }}
		<label for="chofer_form.licencia.id_for_label">Licencia:</label>
		{{ chofer_form.licencia }}
	</div>
	<div class="required field chofer">
		{{ chofer_form.vencimientoLicencia.errors }}
		<label for="chofer_form.vencimientoLicencia.id_for_label">Vencimiento de la licencia:</label>
		{{ chofer_form.vencimientoLicencia }}
	</div>
	<div class="ui grid" >
		<div class="row">
			<div class="sixteen wide column" style="margin: 20px 0">
				{% if not object %}
					<input type="submit" class="ui primary button" name="cargarOtro" value="Guardar y Cargar otro">
				{% endif%}
				<input type="submit" class="ui positive button" name="guardar" value="Guardar">
			</div>
		</div>
	</div>
	<div class="ui error message">
	</div>


</form>
{% endblock %}

{% block customPageJs %}
	$(document).ready(function(){
		$('.field.director').css('display','none');
		$('.field.chofer').css('display','none')
		$('#agregarEmpresa').click(function(){
			var win = window.open('{% url 'empresas:alta' %}', '_blank');
			win.focus();
		})

		$(".empresasDropdown").click(function(){
			var options = '<option value="">Empresas</option>'
			$.get('{% url 'empresas:data' %}', function(data) {
				for(empresa of data.data){
					options += '<option value="' + empresa.cuit + '">' + empresa.razonSocial + ' - ' + empresa.cuit + '</option>'
				}
				$("#empresasDropdown").html(options)
			}, "json")
		})

		function sanitize(str){
			var tuplas = {
				'Director': 'Director', 
				'Administrativo': 'Administrativo', 
				'Inspector': 'Inspector', 
				'JefeDepartamento': 'Jefe de Departamento', 
				'Chofer': 'Chofer', 
				'Solicitante': 'Solicitante', 
				'Liquidador': 'Liquidador', 
				'Sumariante': 'Sumariante'
			}

			return tuplas[str]
		}

		var rolesOptions ='<option value="">Roles</option>'
		
		{% for rol in roles %}
			rolesOptions += '<option value="{{rol}}">' + sanitize('{{rol}}') + '</option>'
		{% endfor %}
		

		$("#rolesDropdown").html(rolesOptions)
		$("#rolesDropdown").change(function(e){
			function any(arr, fn){
				arr.some(fn);
			}
				
			var optionSelected = Array.from($("#rolesDropdown option:selected"))
			if (any(optionSelected, x => x.value == 'Director')) {
				$('.field.director').css('display','inherit');
			} else {
				$('.field.director').css('display','none');
			}
			if (any(optionSelected, function(x){ return x.value == 'Chofer'})) {
				$('.field.chofer').css('display','inherit');
			} else {
				$('.field.chofer').css('display','none');
			}
		})
		


	})

	

{% endblock %}